{"version":3,"sources":["../src/index.ts"],"sourcesContent":["import { AnyDocument, AnyOrama, insertMultiple } from '@orama/orama'\nimport glob from 'glob'\nimport { Content, Element, Parent, Properties, Root } from 'hast'\nimport { fromHtml } from 'hast-util-from-html'\nimport { fromString } from 'hast-util-from-string'\nimport { toHtml } from 'hast-util-to-html'\nimport { toString } from 'hast-util-to-string'\nimport { readFile } from 'node:fs/promises'\nimport { promisify } from 'node:util'\nimport { rehype } from 'rehype'\nimport rehypeDocument from 'rehype-document'\nimport rehypePresetMinify from 'rehype-preset-minify'\nimport remarkParse from 'remark-parse'\nimport remarkRehype from 'remark-rehype'\nimport { unified } from 'unified'\n\nexport type MergeStrategy = 'merge' | 'split' | 'both'\n\nexport const defaultHtmlSchema = {\n  type: 'string',\n  content: 'string',\n  path: 'string'\n} as const\n\nexport interface DefaultSchemaElement extends AnyDocument {\n  type: string\n  content: string\n  path: string\n  properties?: Properties\n}\n\nexport type PopulateFnContext = Record<string, any>\n\ninterface PopulateFromGlobOptions {\n  transformFn?: TransformFn\n  mergeStrategy?: MergeStrategy\n  context?: PopulateFnContext\n}\n\ntype PopulateOptions = PopulateFromGlobOptions & { basePath?: string }\n\ntype FileType = 'html' | 'md'\nconst asyncGlob = promisify(glob)\n\nexport async function populateFromGlob<T extends AnyOrama>(\n  db: T,\n  pattern: string,\n  options?: PopulateFromGlobOptions\n): Promise<void> {\n  const files = await asyncGlob(pattern)\n  await Promise.all(files.map(async filename => populateFromFile(db, filename, options)))\n}\n\nasync function populateFromFile<T extends AnyOrama>(\n  db: T,\n  filename: string,\n  options?: PopulateFromGlobOptions\n): Promise<string[]> {\n  const data = await readFile(filename)\n  const fileType = filename.slice(filename.lastIndexOf('.') + 1) as FileType\n  return populate(db, data, fileType, { ...options, basePath: `${filename}/` })\n}\n\nexport const parseFile = async (\n  data: Buffer | string,\n  fileType: FileType,\n  options?: PopulateOptions\n): Promise<DefaultSchemaElement[]> => {\n  const records: DefaultSchemaElement[] = []\n  switch (fileType) {\n    case 'md':\n      // eslint-disable-next-line no-case-declarations\n      const tree = unified().use(remarkParse).parse(data)\n      await unified()\n        .use(remarkRehype)\n        .use(rehypeDocument)\n        .use(rehypePresetMinify)\n        .use(rehypeOrama, records, options)\n        .run(tree)\n      break\n    case 'html':\n      await rehype().use(rehypePresetMinify).use(rehypeOrama, records, options).process(data)\n      break\n    /* c8 ignore start */\n    default:\n      return fileType\n    /* c8 ignore stop */\n  }\n\n  return records\n}\n\nexport async function populate<T extends AnyOrama>(\n  db: T,\n  data: Buffer | string,\n  fileType: FileType,\n  options?: PopulateOptions\n): Promise<string[]> {\n  return insertMultiple(db, await parseFile(data, fileType, options) as AnyDocument)\n}\n\nfunction rehypeOrama(records: DefaultSchemaElement[], options?: PopulateOptions): (tree: Root) => void {\n  if (!options) {\n    options = {}\n  }\n\n  return (tree: Root) => {\n    tree.children.forEach((child, i) => {\n      visitChildren(\n        child,\n        tree,\n        `${options?.basePath /* c8 ignore next */ ?? ''}root[${i}]`,\n        records,\n        options!,\n        structuredClone(options?.context ?? {})\n      )\n    })\n  }\n}\n\nfunction visitChildren(\n  node: Content,\n  parent: Parent,\n  path: string,\n  records: DefaultSchemaElement[],\n  options: PopulateOptions,\n  context: PopulateFnContext\n): void {\n  if (node.type === 'text') {\n    addRecords(\n      node.value,\n      (parent as Element).tagName,\n      path,\n      (parent as Element).properties,\n      records,\n      options.mergeStrategy ?? 'merge'\n    )\n    return\n  }\n\n  if (!('tagName' in node)) return\n\n  const transformedNode =\n    typeof options?.transformFn === 'function' ? applyTransform(node, options.transformFn, context) : node\n\n  transformedNode.children.forEach((child, i) => {\n    visitChildren(child, transformedNode, `${path}.${transformedNode.tagName}[${i}]`, records, options, context)\n  })\n}\n\nfunction applyTransform(node: Element, transformFn: TransformFn, context: PopulateFnContext): Element {\n  const preparedNode = prepareNode(node)\n  const transformedNode = transformFn(preparedNode, context)\n  return applyChanges(node, transformedNode)\n}\n\nfunction prepareNode(node: Element): NodeContent {\n  const tag = node.tagName\n  const content = toString(node)\n  const raw = toHtml(node)\n  const properties = node.properties\n  return { tag, content, raw, properties }\n}\n\nfunction applyChanges(node: Element, transformedNode: NodeContent): Element {\n  let changed = node\n\n  if (toHtml(node) !== transformedNode.raw) {\n    changed = fromHtml(transformedNode.raw, { fragment: true }).children[0] as Element\n  } else {\n    node.tagName = transformedNode.tag\n    if (toString(node) !== transformedNode.content) {\n      changed = fromString(node, transformedNode.content)\n    }\n  }\n\n  changed.properties = { ...changed.properties, ...transformedNode.additionalProperties }\n  return changed\n}\n\nfunction addRecords(\n  content: string,\n  type: string,\n  path: string,\n  properties: Properties | undefined,\n  records: DefaultSchemaElement[],\n  mergeStrategy: MergeStrategy\n): void {\n  const parentPath = path.substring(0, path.lastIndexOf('.'))\n  const newRecord = { type, content, path: parentPath, properties }\n  switch (mergeStrategy) {\n    case 'merge':\n      if (!isRecordMergeable(parentPath, type, records)) {\n        records.push(newRecord)\n        return\n      }\n      addContentToLastRecord(records, content, properties)\n      return\n    case 'split':\n      records.push(newRecord)\n      return\n    case 'both':\n      if (!isRecordMergeable(parentPath, type, records)) {\n        records.push(newRecord, { ...newRecord })\n        return\n      }\n      records.splice(records.length - 1, 0, newRecord)\n      addContentToLastRecord(records, content, properties)\n  }\n}\n\nfunction isRecordMergeable(path: string, tag: string, records: DefaultSchemaElement[]): boolean {\n  if (!records.length) return false\n  const lastRecord = records[records.length - 1]\n  const parentPath = pathWithoutLastIndex(path)\n  const lastPath = pathWithoutLastIndex(lastRecord.path)\n  return parentPath === lastPath && tag === lastRecord.type\n}\n\nfunction pathWithoutLastIndex(path: string): string {\n  const lastBracket = path.lastIndexOf('[')\n  return path.slice(0, lastBracket)\n}\n\nfunction addContentToLastRecord(\n  records: Array<DefaultSchemaElement & { properties?: Properties }>,\n  content: string,\n  properties?: Properties\n): void {\n  const lastRecord = records[records.length - 1]\n  lastRecord.content += ` ${content}`\n  lastRecord.properties = { ...properties, ...lastRecord.properties }\n}\n\nexport interface NodeContent {\n  tag: string\n  raw: string\n  content: string\n  properties?: Properties\n  additionalProperties?: Properties\n}\n\nexport type TransformFn = (node: NodeContent, context: PopulateFnContext) => NodeContent\n"],"names":["insertMultiple","glob","fromHtml","fromString","toHtml","toString","readFile","promisify","rehype","rehypeDocument","rehypePresetMinify","remarkParse","remarkRehype","unified","defaultHtmlSchema","type","content","path","asyncGlob","populateFromGlob","db","pattern","options","files","Promise","all","map","filename","populateFromFile","data","fileType","slice","lastIndexOf","populate","basePath","parseFile","records","tree","use","parse","rehypeOrama","run","process","children","forEach","child","i","visitChildren","structuredClone","context","node","parent","addRecords","value","tagName","properties","mergeStrategy","transformedNode","transformFn","applyTransform","preparedNode","prepareNode","applyChanges","tag","raw","changed","fragment","additionalProperties","parentPath","substring","newRecord","isRecordMergeable","push","addContentToLastRecord","splice","length","lastRecord","pathWithoutLastIndex","lastPath","lastBracket"],"mappings":"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"}